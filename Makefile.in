# Standard installation pathnames
# See the file LICENSE for the license
SHELL 		= @SHELL@
srcdir 		= @srcdir@
basesrcdir	= $(shell basename `pwd`)
prefix  	= @prefix@
exec_prefix 	= @exec_prefix@
bindir 		= @bindir@
mandir 		= @mandir@

CC 		= @CC@
CPPFLAGS	= @CPPFLAGS@ @DEFS@ -I. -I$(srcdir)
CFLAGS 		= @CFLAGS@
LDFLAGS		= @LDFLAGS@	-lcrypto
LIBS 		= @LIBS@
LIBOBJS		= @LIBOBJS@
DATE		= $(shell date +%Y%m%d)
LIBTOOL		= @srcdir@/libtool

LINT		= splint
LINTFLAGS	= +quiet -weak -warnposix -unrecog -Din_addr_t=uint32_t -Du_int=unsigned -Du_char=uint8_t 

#INSTALL = $(srcdir)/install-sh -c
#INSTALL_PROGRAM = $(INSTALL)

LIBDNS_SOURCES	=	rdata.c util.c rr.c packet.c wire2host.c \
			host2str.c buffer.c str2host.c resolver.c \
			net.c host2wire.c dname.c dnssec.c keys.c \
			higher.c rr_functions.c
LIBDNS_HEADERS	=	ldns/error.h		\
			ldns/packet.h		\
			ldns/prototype.h 	\
			ldns/rdata.h 		\
			ldns/rr.h		\
			ldns/wire2host.h	\
			ldns/host2str.h		\
			ldns/host2wire.h	\
			ldns/str2host.h		\
			ldns/buffer.h		\
			ldns/resolver.h		\
			ldns/net.h		\
			ldns/dname.h		\
			ldns/dnssec.h		\
			ldns/keys.h		\
			ldns/higher.h		\
			util.h
PROG_SOURCES	=	mx.c
PROG_TARGETS	=	$(PROG_SOURCES:.c=)

LIBDNS_OBJECTS	=	$(LIBDNS_SOURCES:.c=.o)

TEST_SOURCES	=	run-test0.c run-test1.c run-test2.c run-test3.c \
			run-test4.c run-test5.c run-test6.c run-test7.c \
			run-test8.c run-test9.c run-test10.c run-test11.c \
			run-test13.c run-test14.c run-test15.c run-test16.c \
			run-test17.c run-test18.c

#ALL_SOURCES	=	$(TEST_SOURCES) $(LIBDNS_SOURCES) $(PROG_SOURCES)
ALL_SOURCES	=	$(LIBDNS_SOURCES) $(PROG_SOURCES)

TESTS		=	$(TEST_SOURCES:.c=)

COMPILE		= $(CC) $(CPPFLAGS) $(CFLAGS)
COMP_LIB	= $(LIBTOOL) $(CC) $(CPPFLAGS) $(CFLAGS)
LINK		= $(CC) $(CFLAGS) $(LDFLAGS)
LINK_LIB	= $(LIBTOOL) $(CC) $(CFLAGS) $(LDFLAGS)

%.o:	$(srcdir)/%.c
	$(COMPILE) -c $<
#	$(COMP_LIB) -c $<

.PHONY:	clean realclean docclean doc lint test all ar

all:		$(PROG_TARGETS) libldns.a

ar:		libldns.a

libldns.a:	$(LIBDNS_OBJECTS) b64_pton$U.o b64_ntop$U.o
		ar rc libldns.a $(LIBDNS_OBJECTS) b64_pton$U.o b64_ntop$U.o
		ranlib libldns.a

snapshot:	clean testclean
		(rm -rf ../ldns-snap-$(DATE)/)
		(cd .. ; cp -r $(basesrcdir)/ ldns-snap-$(DATE)/)
		(cd .. ; tar --verbose  --exclude ".svn" --create --file ldns-snap-$(DATE).tar.gz --gzip ldns-snap-$(DATE)/)
		(rm -rf ../ldns-snap-$(DATE)/)

mx:		mx.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+

# tests

run-test0:	run-test0.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test1:	run-test1.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test2:	run-test2.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test3:	run-test3.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test4:	run-test4.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test5:	run-test5.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test6:	run-test6.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test7:	run-test7.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test8:	run-test8.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test9:	run-test9.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test10:	run-test10.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test11:	run-test11.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test12:	run-test12.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) -lpcap ${LIBS} -o $@ $+
run-test13:	run-test13.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test14:	run-test14.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test15:	run-test15.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test16:	run-test16.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test17:	run-test17.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+
run-test18:	run-test18.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+

run-test-trace:	run-test-trace.o $(LIBDNS_OBJECTS) $(LIBOBJS)
		$(LINK) ${LIBS} -o $@ $+

doc:	
	doxygen libdns.doxygen

clean:	
	rm -f *.o *.d
	rm -f $(TESTS)
	rm -f $(PROG_TARGETS)
	rm -rf autom4te.cache/
	rm -f config.status
	rm -f config.log
	rm -f libldns.a
	rm -f tags

testclean:
	rm -f $(TESTS)

realclean: clean docclean testclean
	rm -f config.status
	rm -f config.log
	rm -f Makefile
	rm -f config.h
	rm -f config.h.in
	rm -f configure
	rm -f libtool

docclean:
	rm -rf doc/html/
	rm -rf doc/man/
	rm -rf doc/latex/

test0: run-test0
	./run-test0
test1: run-test1
	./run-test1
test2: run-test2
	./run-test2
test3: run-test3
	./run-test3
test4: run-test4
	./run-test4
test5: run-test5
	./run-test5
test6: run-test6
	./run-test6
test7: run-test7
	./run-test7
test8: run-test8
	./run-test8
test9: run-test9
	./run-test9
test10: run-test10
	./run-test10
test11: run-test11
	./run-test11
test12: run-test12
	./run-test11
test13: run-test13
	./run-test11
test14: run-test14
	./run-test11
test15: run-test15
	./run-test15
test16: run-test16
	./run-test16
test17: run-test17
	./run-test17
test18: run-test18
	./run-test18

test: test0 test1 test2 test3 test4 test5 test6 test7 test8 test9 test10 test11	\
	test13 test14 test15 test16 test17 test18

## No need for changes here

lint:
	for i in $(LIBDNS_SOURCES); do \
		$(LINT) $(LINTFLAGS) -I. -I$(srcdir) $(srcdir)/$$i ; \
	done

tags:	*.c *.h ldns/*.[ch]
	ctags *.[ch] ldns/*.[ch]

timegm$U.o:	compat/timegm.c
	$(COMPILE) -c compat/timegm.c -o $@

b64_pton$U.o:	compat/b64_pton.c
	$(COMPILE) -c compat/b64_pton.c -o $@

b64_ntop$U.o:	compat/b64_ntop.c
	$(COMPILE) -c compat/b64_ntop.c -o $@

malloc$U.o:	compat/malloc.c
	$(COMPILE) -c compat/malloc.c -o $@

# Automatic dependencies.
%.d: $(srcdir)/%.c
	$(SHELL) -ec '$(CC) -MM $(CPPFLAGS) $< \
	              | sed '\''s!\(.*\)\.o[ :]*!$(dir $@)\1.o $@ : !g'\'' > $@; \
	              [ -s $@ ] || rm -f $@'

include $(ALL_SOURCES:.c=.d)
